# check python version 
python3 --version 
# Note that odoo14 working with python 3.8 
# install requirments 
sudo apt update
sudo apt install git python3-pip build-essential wget python3-dev python3-venv \
    python3-wheel libfreetype6-dev libxml2-dev libzip-dev libldap2-dev libsasl2-dev \
    python3-setuptools node-less libjpeg-dev zlib1g-dev libpq-dev \
    libxslt1-dev libldap2-dev libtiff5-dev libjpeg8-dev libopenjp2-7-dev \
    liblcms2-dev libwebp-dev libharfbuzz-dev libfribidi-dev libxcb1-dev

# create system user on the server
sudo useradd -m -d /opt/odoo17 -U -r -s /bin/bash odoo17

# install postgresql and create user
sudo apt install postgresql
sudo su - postgres -c "createuser -s odoo17"

# install wkhtmltopdf 
sudo apt install wkhtmltopdf
# if there is any problem with printing pdfs in old odoo versions 
sudo wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.bionic_amd64.deb
sudo apt install ./wkhtmltox_0.12.5-1.bionic_amd64.deb

# switch to your odoo user
sudo su - odoo17

# pull the odoo repo 
git clone https://www.github.com/odoo/odoo --depth 1 --branch 17.0 /opt/odoo17/odoo17.0

# create your virtual environment, activate it and install prerequisites 
# if there any package error installation find the dependence and solve it 
python3 -m venv odoo17.0-venv
source odoo17.0-venv/bin/activate
pip3 install wheel
pip3 install -r odoo17.0/requirements.txt
deactivate 

# make directory to custom andons
mkdir custom

# pull enterprise addons using vaild key and passwd
git clone https://github.com/odoo/enterprise.git --depth 1 --branch 17.0 /opt/odoo17/enterprise

# exit your odoo user
exit

# create  odoo log file 
sudo mkdir /var/log/odoo17
sudo chown odoo17:odoo17 /var/log/odoo17

# create odoo conf file 
sudo nano /etc/odoo17.conf
#[options]
#; This is the password that allows database operations:
#admin_passwd = PCPowerOdoo@2025
#db_host = False
#db_port = False
#db_user = odoo17
#db_password = False
#http_port = 8017
#addons_path = /opt/odoo17/odoo17.0/addons, /opt/odoo17/enterprise, /opt/odoo17/custom
#logfile = /var/log/odoo17/odoo17.log


# create systemd service file , enabled it and check its status 
sudo nano /etc/systemd/system/odoo17.service
#[Unit]
#Description=Odoo17
#Requires=postgresql.service
#After=network.target postgresql.service
#
#[Service]
#Type=simple
#SyslogIdentifier=odoo17
#PermissionsStartOnly=true
#User=odoo17
#Group=odoo17
#ExecStart=/opt/odoo17/odoo17.0-venv/bin/python3 /opt/odoo17/odoo17.0/odoo-bin -c /etc/odoo17.conf
#StandardOutput=journal+console
#
#[Install]
#WantedBy=multi-user.target
sudo systemctl daemon-reload
sudo systemctl enable --now odoo17
sudo systemctl status odoo17


# install nginx , enable it and check its status 
sudo apt update
sudo apt install -y nginx
sudo systemctl enable nginx
sudo systemctl start nginx
systemctl status nginx

# allow firewall 
sudo ufw allow 'Nginx Full'
sudo ufw reload

# create nginx config file for odoo17
sudo nano /etc/nginx/sites-available/odoo17-test

## Odoo 17 - test.pcpower.app
#upstream odoo17 {
#    server 127.0.0.1:8017;
#}
#
#upstream odoo17_chat {
#    server 127.0.0.1:8072;
#}
#
#server {
#    listen 80;
#    server_name test.pcpower.app;
#
#    proxy_read_timeout 720s;
#    proxy_connect_timeout 720s;
#    proxy_send_timeout 720s;
#
#    proxy_set_header X-Forwarded-Host $host;
#    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#    proxy_set_header X-Forwarded-Proto $scheme;
#    proxy_set_header X-Real-IP $remote_addr;
#
#    access_log /var/log/nginx/odoo17.access.log;
#    error_log  /var/log/nginx/odoo17.error.log;
#
#    # Main Odoo
#    location / {
#        proxy_pass http://odoo17;
#        proxy_redirect off;
#    }
#
#    # Longpolling (chat, bus)
#    location /longpolling {
#        proxy_pass http://odoo17_chat;
#    }
#
#    # Static files
#    location ~* /web/static/ {
#        proxy_cache_valid 200 90m;
#        proxy_buffering on;
#        expires 10d;
#        proxy_pass http://odoo17;
#    }
#
#    gzip on;
#    gzip_types text/css text/scss text/plain text/xml application/json application/javascript;
#}

# enable this site with nginx
sudo ln -s /etc/nginx/sites-available/odoo17-test /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# update odoo conf file with this params and restart service
sudo nano /etc/odoo17.conf
#proxy_mode = True
#xmlrpc_interface = 127.0.0.1
#longpolling_port = 8072
sudo systemctl restart odoo17

# install certificate ssl HTTPS and link it with site
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d test.pcpower.app


